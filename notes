# main.py - FastAPI —Å–µ—Ä–≤–µ—Ä –¥–ª—è –±—Ä–∞—Å–ª–µ—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Ö–æ–¥–∫–∏

from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy import create_engine, Column, Integer, Float, DateTime, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session
from pydantic import BaseModel, Field, validator
from typing import List
from datetime import datetime
import logging

# ============================================
# –ù–ê–°–¢–†–û–ô–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• (SQLAlchemy)
# ============================================

# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLite (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ PostgreSQL)
DATABASE_URL = "sqlite:///./gait_monitoring.db"
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω: "postgresql://user:password@localhost/gait_db"

engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False}  # –¢–æ–ª—å–∫–æ –¥–ª—è SQLite
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# ============================================
# –ú–û–î–ï–õ–¨ –ë–ê–ó–´ –î–ê–ù–ù–´–• (SQLAlchemy)
# ============================================

class IMUDataDB(Base):
    """
    –ú–æ–¥–µ–ª—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö IMU (Inertial Measurement Unit)
    –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ–¥–∏–Ω —Å–µ–º–ø–ª —Å –±—Ä–∞—Å–ª–µ—Ç–∞
    """
    __tablename__ = "imu_data"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String, index=True, nullable=False)  # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    timestamp = Column(DateTime, default=datetime.utcnow, index=True)

    # –î–∞–Ω–Ω—ã–µ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ (–º/—Å¬≤)
    accel_x = Column(Float, nullable=False)
    accel_y = Column(Float, nullable=False)
    accel_z = Column(Float, nullable=False)

    # –î–∞–Ω–Ω—ã–µ –≥–∏—Ä–æ—Å–∫–æ–ø–∞ (—Ä–∞–¥/—Å –∏–ª–∏ –≥—Ä–∞–¥/—Å)
    gyro_x = Column(Float, nullable=False)
    gyro_y = Column(Float, nullable=False)
    gyro_z = Column(Float, nullable=False)

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –±—Ä–∞—Å–ª–µ—Ç–µ)
    # mag_x = Column(Float, nullable=True)
    # mag_y = Column(Float, nullable=True)
    # mag_z = Column(Float, nullable=True)

# –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
Base.metadata.create_all(bind=engine)

# ============================================
# PYDANTIC –ú–û–î–ï–õ–ò (–í–∞–ª–∏–¥–∞—Ü–∏—è)
# ============================================

class IMUSample(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —Å–µ–º–ø–ª–∞ –æ—Ç –±—Ä–∞—Å–ª–µ—Ç–∞
    Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ç–∏–ø—ã –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    """
    user_id: str = Field(..., min_length=1, max_length=100)
    timestamp: datetime = Field(default_factory=datetime.utcnow)

    # –ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä: –æ–±—ã—á–Ω–æ –æ—Ç -16g –¥–æ +16g (–≥–¥–µ g = 9.81 –º/—Å¬≤)
    accel_x: float = Field(..., ge=-200.0, le=200.0)
    accel_y: float = Field(..., ge=-200.0, le=200.0)
    accel_z: float = Field(..., ge=-200.0, le=200.0)

    # –ì–∏—Ä–æ—Å–∫–æ–ø: –æ–±—ã—á–Ω–æ –æ—Ç -2000 –¥–æ +2000 –≥—Ä–∞–¥/—Å
    gyro_x: float = Field(..., ge=-3000.0, le=3000.0)
    gyro_y: float = Field(..., ge=-3000.0, le=3000.0)
    gyro_z: float = Field(..., ge=-3000.0, le=3000.0)

    class Config:
        json_schema_extra = {
            "example": {
                "user_id": "user_12345",
                "timestamp": "2025-12-20T10:30:00",
                "accel_x": 0.98,
                "accel_y": 0.15,
                "accel_z": 9.81,
                "gyro_x": 0.5,
                "gyro_y": -1.2,
                "gyro_z": 0.3
            }
        }

class IMUBatchRequest(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è –±–∞—Ç—á–∞ —Å–µ–º–ø–ª–æ–≤ (–æ–±—ã—á–Ω–æ 50 —à—Ç—É–∫ –∑–∞ —Ä–∞–∑)
    """
    samples: List[IMUSample] = Field(..., min_items=1, max_items=100)

    @validator('samples')
    def check_user_consistency(cls, samples):
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–µ–º–ø–ª—ã –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if len(samples) > 1:
            first_user = samples[0].user_id
            if not all(s.user_id == first_user for s in samples):
                raise ValueError("–í—Å–µ —Å–µ–º–ø–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        return samples

class IMUBatchResponse(BaseModel):
    """–û—Ç–≤–µ—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
    success: bool
    samples_saved: int
    message: str

# ============================================
# DEPENDENCY: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ë–î
# ============================================

def get_db():
    """Dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ============================================
# FASTAPI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
# ============================================

app = FastAPI(
    title="Gait Monitoring API",
    description="API –¥–ª—è –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö —Å –±—Ä–∞—Å–ª–µ—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Ö–æ–¥–∫–∏",
    version="1.0.0"
)

# CORS –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ============================================
# ENDPOINTS
# ============================================

@app.get("/")
def root():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API"""
    return {
        "message": "Gait Monitoring API —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "version": "1.0.0",
        "endpoints": {
            "POST /api/imu/batch": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞—Ç—á IMU –¥–∞–Ω–Ω—ã—Ö",
            "GET /api/imu/stats": "–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
        }
    }

@app.post(
    "/api/imu/batch",
    response_model=IMUBatchResponse,
    status_code=status.HTTP_201_CREATED
)
def save_imu_batch(
    batch: IMUBatchRequest,
    db: Session = Depends(get_db)
):
    """
    –û—Å–Ω–æ–≤–Ω–æ–π endpoint –¥–ª—è –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö —Å –±—Ä–∞—Å–ª–µ—Ç–∞

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. Pydantic –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JSON (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Pydantic –º–æ–¥–µ–ª–∏ –≤ SQLAlchemy –º–æ–¥–µ–ª–∏
    3. Bulk insert –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    """
    try:
        logger.info(f"–ü–æ–ª—É—á–µ–Ω –±–∞—Ç—á –∏–∑ {len(batch.samples)} —Å–µ–º–ø–ª–æ–≤ –æ—Ç {batch.samples[0].user_id}")

        # –®–∞–≥ 2: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Pydantic ‚Üí SQLAlchemy
        db_samples = [
            IMUDataDB(
                user_id=sample.user_id,
                timestamp=sample.timestamp,
                accel_x=sample.accel_x,
                accel_y=sample.accel_y,
                accel_z=sample.accel_z,
                gyro_x=sample.gyro_x,
                gyro_y=sample.gyro_y,
                gyro_z=sample.gyro_z
            )
            for sample in batch.samples
        ]

        # –®–∞–≥ 3: Bulk Insert - –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨!
        db.add_all(db_samples)  # –î–æ–±–∞–≤–ª—è–µ–º –í–°–ï —Å—Ä–∞–∑—É
        db.commit()  # –û–¥–∏–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –≤—Å–µ—Ö

        logger.info(f"–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(db_samples)} —Å–µ–º–ø–ª–æ–≤")

        return IMUBatchResponse(
            success=True,
            samples_saved=len(db_samples),
            message=f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(db_samples)} —Å–µ–º–ø–ª–æ–≤"
        )

    except Exception as e:
        db.rollback()  # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: {str(e)}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {str(e)}"
        )

@app.get("/api/imu/stats")
def get_stats(
    user_id: str = None,
    db: Session = Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–∞–Ω–Ω—ã–º
    """
    try:
        query = db.query(IMUDataDB)

        if user_id:
            query = query.filter(IMUDataDB.user_id == user_id)

        total_samples = query.count()

        if total_samples == 0:
            return {"message": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"}

        latest = query.order_by(IMUDataDB.timestamp.desc()).first()
        oldest = query.order_by(IMUDataDB.timestamp.asc()).first()

        return {
            "total_samples": total_samples,
            "user_id": user_id or "–≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            "oldest_sample": oldest.timestamp if oldest else None,
            "latest_sample": latest.timestamp if latest else None
        }

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=str(e)
        )

@app.delete("/api/imu/clear")
def clear_data(
    user_id: str = None,
    confirm: bool = False,
    db: Session = Depends(get_db)
):
    """
    –û–ü–ê–°–ù–û: –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    –¢—Ä–µ–±—É–µ—Ç confirm=true
    """
    if not confirm:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="–î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä ?confirm=true –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
        )

    try:
        query = db.query(IMUDataDB)

        if user_id:
            deleted = query.filter(IMUDataDB.user_id == user_id).delete()
        else:
            deleted = query.delete()

        db.commit()

        return {
            "success": True,
            "deleted_samples": deleted,
            "message": f"–£–¥–∞–ª–µ–Ω–æ {deleted} –∑–∞–ø–∏—Å–µ–π"
        }

    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=str(e)
        )

# ============================================
# –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê
# ============================================

if __name__ == "__main__":
    import uvicorn

    print("=" * 50)
    print("üöÄ –ó–∞–ø—É—Å–∫ Gait Monitoring API —Å–µ—Ä–≤–µ—Ä–∞")
    print("=" * 50)
    print("üìç –ê–¥—Ä–µ—Å: http://localhost:8000")
    print("üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs")
    print("=" * 50)

    uvicorn.run(app, host="0.0.0.0", port=8000)